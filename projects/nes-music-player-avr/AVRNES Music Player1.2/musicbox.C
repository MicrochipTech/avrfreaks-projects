//NES音乐播放器   AVRNES Music Player1.2

//          BY张皓
//http://www.lotusinvention.cn/ART/nes/NESMusic.htm
//  ICC-AVR Target : ATMEGA16  Crystal: 8M,
#include <iom16v.h>
#include <macros.h>

#define uchar unsigned char
#define schar signed char
#define uint unsigned int  
#define sint signed int  
#define SET_BIT(io ,bit) (   io |=  (1<<bit) )   
#define CLR_BIT(io ,bit) (   io &= ~(1<<bit) )   
#define GET_BIT(pin,bit) ( pin &    (1<<bit) ) 

const uint music_dataRect0[]={20,15,48,52, 20,11,52,55, 17,15,55,59, 17,11,59,62, 13,15,62,66, 13,11,66,69, 10,15,69,73, 10,11,73,76, 13,15,76,80, 13,11,80,84, 13,7,84,95, 13,3,95,97, 15,10,158,162, 15,6,162,168, 20,10,168,175, 20,6,175,181, 15,10,181,188, 15,6,188,194, 14,10,194,207, 14,6,207,214, 14,2,214,217, 10,10,220,233, 10,6,233,240, 10,2,240,243, 14,10,246,257, 14,6,257,262, 14,2,262,264, 15,10,266,275, 15,6,275,280, 15,2,280,282, 20,10,284,289, 20,6,289,293, 15,10,293,298, 15,6,298,302, 20,10,302,307, 20,6,307,311, 15,10,311,316, 15,6,316,320, 14,10,320,325, 14,6,325,329, 15,10,329,334, 15,6,334,338, 20,10,338,343, 20,6,343,347, 15,10,347,352, 15,6,352,356, 14,10,356,365, 14,6,365,370, 14,2,370,372, 10,10,374,383, 10,6,383,388, 10,2,388,390, 14,10,392,401, 14,6,401,406, 14,2,406,408, 15,10,410,419, 15,6,419,424, 15,2,424,426, 20,10,428,433, 20,6,433,437, 15,10,437,442, 15,6,442,446, 20,10,446,451, 20,6,451,455, 15,10,455,460, 15,6,460,464, 14,10,464,469, 14,6,469,473, 15,10,473,478, 15,6,478,484, 20,10,484,491, 20,6,491,497, 15,10,497,504, 15,6,504,510, 14,10,510,523, 14,6,523,530, 14,2,530,533, 10,10,536,549, 10,6,549,556, 10,2,556,559, 14,10,562,573, 14,6,573,578, 14,2,578,580, 15,10,582,591, 15,6,591,596, 15,2,596,598, 20,10,600,605, 20,6,605,609, 15,10,609,614, 15,6,614,618, 20,10,618,623, 20,6,623,627, 15,10,627,632, 15,6,632,636, 14,10,636,641, 14,6,641,645, 15,10,645,650, 15,6,650,654, 20,10,654,659, 20,6,659,663, 15,10,663,668, 15,6,668,672, 14,10,672,681, 14,6,681,686, 14,2,686,688, 10,10,690,699, 10,6,699,704, 10,2,704,706, 14,10,708,717, 14,6,717,722, 14,2,722,724, 15,10,726,735, 15,6,735,740, 15,2,740,742, 20,10,744,749, 20,6,749,753, 15,10,753,758, 15,6,758,762, 20,10,762,767, 20,6,767,771, 15,10,771,776, 15,6,776,780, 14,10,780,785, 14,6,785,789, 6,15,832,836, 7,11,836,841, 7,7,841,842, 6,15,843,848, 7,11,848,852, 23,15,852,856, 13,15,856,858, 19,15,858,859, 23,15,859,860, 23,15,861,864, 13,15,864,865, 19,15,865,867, 23,15,867,869, 26,15,869,872, 23,15,872,875, 13,15,875,877, 19,15,877,878, 23,15,878,880, 26,15,880,884, 12,15,884,885, 16,15,885,886, 19,15,886,888, 10,15,888,889, 13,15,889,892, 9,15,892,893, 6,15,952,956, 7,11,956,959, 7,7,959,962, 8,5,962,966, 9,3,966,969, 23,15,977,979, 13,15,979,980, 19,15,980,982, 23,15,982,983, 26,15,983,985, 12,15,985,986, 16,15,986,987, 19,15,987,989, 10,15,989,991, 13,15,991,993, 9,15,993,994, 23,15,998,1001, 13,15,1001,1002, 19,15,1002,1003, 23,15,1003,1004, 26,15,1004,1006, 12,15,1006,1007, 16,15,1007,1009, 19,15,1009,1011, 10,15,1011,1012, 13,15,1012,1014, 9,15,1014,1015, 6,15,1036,1039, 7,11,1039,1042, 7,7,1042,1046, 8,5,1046,1049, 9,3,1049,1051, 23,15,1051,1054, 13,15,1054,1055, 19,15,1055,1056, 23,15,1056,1057, 26,15,1057,1059, 12,15,1059,1060, 16,15,1060,1061, 19,15,1061,1064, 10,15,1064,1065, 13,15,1065,1067, 9,15,1067,1068, 6,15,1075,1078, 7,11,1078,1082, 7,7,1082,1085, 8,5,1085,1088, 9,3,1088,1092, 6,15,1094,1097, 23,15,1097,1100, 13,15,1100,1101, 19,15,1101,1102, 23,15,1102,1103, 26,15,1103,1105, 12,15,1105,1106, 16,15,1106,1108, 19,15,1108,1110, 10,15,1110,1112, 13,15,1112,1115, 9,15,1115,1116, 6,15,1165,1170, 7,11,1170,1175, 7,7,1175,1176, 23,15,1177,1180, 13,15,1180,1181, 19,15,1181,1183, 23,15,1183,1185, 26,15,1185,1188, 12,15,1188,1190, 16,15,1190,1191, 19,15,1191,1194, 10,15,1194,1196, 13,15,1196,1200, 9,15,1200,1201, 23,15,1221,1223, 13,15,1223,1224, 19,15,1224,1226, 23,15,1226,1227, 26,15,1227,1229, 12,15,1229,1230, 16,15,1230,1231, 19,15,1231,1233, 10,15,1233,1235, 13,15,1235,1237, 9,15,1237,1238, 23,15,1255,1257, 13,15,1257,1258, 19,15,1258,1259, 23,15,1259,1260, 26,15,1260,1263, 12,15,1263,1264, 16,15,1264,1265, 19,15,1265,1267, 10,15,1267,1268, 13,15,1268,1271, 9,15,1271,1272, 6,15,1309,1312, 7,11,1312,1316, 7,7,1316,1319, 8,5,1319,1322, 9,3,1322,1326, 55,15,1383,1385, 14,14,1387,1389, 20,14,1389,1391, 29,14,1391,1393, 40,14,1393,1395, 55,14,1395,1397, 55,13,1399,1401, 14,12,1403,1405, 20,12,1405,1407, 29,12,1407,1409, 40,12,1409,1411, 55,12,1411,1413, 55,11,1415,1417, 14,10,1419,1421, 20,10,1421,1424, 29,10,1424,1427, 40,10,1427,1431, 55,10,1431,1434, 55,9,1437,1440, 14,8,1444,1447, 20,8,1447,1450, 29,8,1450,1453, 40,8,1453,1457, 55,8,1457,1460, 55,7,1463,1466, 14,6,1470,1473, 20,6,1473,1476, 29,6,1476,1479, 40,6,1479,1483, 55,6,1483,1486, 55,5,1489,1492, 14,4,1495,1497, 20,4,1497,1499, 29,4,1499,1501, 40,4,1501,1503, 55,4,1503,1505, 55,3,1507,1509, 14,3,1511,1513, 20,3,1513,1515, 29,3,1515,1517, 40,3,1517,1519, 55,3,1519,1521, 55,3,1523,1525, 15,10,1558,1562, 15,6,1562,1568, 20,10,1568,1575, 20,6,1575,1581, 15,10,1581,0, 9999,9999,9999,9999};
const uint music_dataRect1[]={136,10,48,52, 136,6,52,55, 102,10,55,59, 102,6,59,62, 81,10,62,66, 81,6,66,69, 68,10,69,73, 68,6,73,76, 81,10,76,80, 81,6,80,93, 81,2,93,95, 41,15,158,288, 41,11,299,302, 41,15,311,317, 41,11,317,320, 46,15,329,443, 46,11,443,446, 46,15,455,461, 46,11,461,464, 51,15,473,604, 51,11,615,618, 51,15,627,633, 51,11,633,636, 46,15,645,759, 46,11,759,762, 48,15,789,794, 48,11,794,800, 54,15,800,807, 54,11,807,813, 48,15,813,820, 48,11,820,826, 43,15,826,833, 43,11,833,839, 43,7,839,846, 43,3,846,851, 41,15,852,859, 41,11,859,865, 41,7,865,872, 41,3,872,877, 43,15,878,885, 43,11,885,889, 43,7,889,894, 43,3,894,897, 48,15,898,903, 48,11,903,907, 48,7,907,912, 48,3,912,915, 54,15,916,921, 54,11,921,925, 48,15,925,930, 48,11,930,934, 54,15,934,939, 54,11,939,943, 48,15,943,948, 48,11,948,952, 61,15,952,957, 61,11,957,961, 48,15,961,966, 48,11,966,970, 54,15,970,975, 54,11,975,979, 48,15,979,984, 48,11,984,988, 43,15,988,993, 43,11,993,997, 43,7,997,1002, 43,3,1002,1005, 41,15,1006,1011, 41,11,1011,1015, 41,7,1015,1020, 41,3,1020,1023, 43,15,1024,1029, 43,11,1029,1033, 43,7,1033,1038, 43,3,1038,1041, 48,15,1042,1047, 48,11,1047,1051, 48,7,1051,1056, 48,3,1056,1059, 54,15,1060,1065, 54,11,1065,1069, 48,15,1069,1074, 48,11,1074,1078, 54,15,1078,1083, 54,11,1083,1087, 48,15,1087,1092, 48,11,1092,1096, 61,15,1096,1101, 61,11,1101,1105, 54,15,1105,1110, 54,11,1110,1116, 61,15,1116,1123, 61,11,1123,1129, 54,15,1129,1136, 54,11,1136,1142, 48,15,1142,1149, 48,11,1149,1155, 48,7,1155,1162, 48,3,1162,1167, 46,15,1168,1175, 46,11,1175,1181, 46,7,1181,1188, 46,3,1188,1193, 48,15,1194,1201, 48,11,1201,1205, 48,7,1205,1210, 48,3,1210,1213, 54,15,1214,1219, 54,11,1219,1223, 54,7,1223,1228, 54,3,1228,1231, 48,15,1232,1237, 48,11,1237,1241, 54,15,1241,1246, 54,11,1246,1250, 61,15,1250,1334, 61,11,1334,1338, 61,7,1338,1343, 61,3,1343,1346, 72,15,1349,1354, 72,11,1354,1358, 64,15,1358,1363, 64,11,1363,1367, 61,15,1367,1372, 61,11,1372,1376, 54,15,1376,1381, 43,15,1383,1385, 3,14,1387,1389, 9,14,1389,1391, 17,14,1391,1393, 29,14,1393,1395, 43,14,1395,1397, 43,13,1399,1401, 3,12,1403,1405, 9,12,1405,1407, 17,12,1407,1409, 29,12,1409,1411, 43,12,1411,1413, 43,11,1415,1417, 3,10,1419,1421, 9,10,1421,1424, 17,10,1424,1427, 29,10,1427,1431, 43,10,1431,1434, 43,9,1437,1440, 3,8,1444,1447, 9,8,1447,1450, 17,8,1450,1453, 29,8,1453,1457, 43,8,1457,1460, 43,7,1463,1466, 3,6,1470,1473, 9,6,1473,1476, 17,6,1476,1479, 29,6,1479,1483, 43,6,1483,1486, 43,5,1489,1492, 3,4,1495,1497, 9,4,1497,1499, 17,4,1499,1501, 29,4,1501,1503, 43,4,1503,1505, 43,3,1507,1509, 3,3,1511,1513, 9,3,1513,1515, 17,3,1515,1517, 29,3,1517,1519, 43,3,1519,1521, 43,3,1523,1525, 41,15,1558,0};
const uint music_dataTriangle[]={34,48,55, 26,55,62, 20,62,69, 17,69,76, 20,76,159, 15,159,170, 20,170,183, 15,183,196, 14,196,222, 10,222,248, 14,248,267, 15,267,285, 20,285,294, 15,294,303, 20,303,312, 15,312,321, 14,321,330, 15,330,339, 20,339,348, 15,348,357, 14,357,375, 10,375,393, 14,393,411, 15,411,429, 20,429,438, 15,438,447, 20,447,456, 15,456,465, 14,465,474, 15,474,486, 20,486,499, 15,499,512, 14,512,538, 10,538,564, 14,564,583, 15,583,601, 20,601,610, 15,610,619, 20,619,628, 15,628,637, 14,637,646, 15,646,655, 20,655,664, 15,664,673, 14,673,691, 10,691,709, 14,709,727, 15,727,745, 20,745,754, 15,754,763, 20,763,772, 15,772,781, 14,781,790, 41,790,815, 30,815,841, 41,841,867, 30,867,890, 41,890,908, 30,908,926, 41,926,944, 30,944,962, 41,962,980, 30,980,998, 41,998,1016, 30,1016,1034, 41,1034,1052, 30,1052,1070, 41,1070,1088, 30,1088,1106, 46,1106,1131, 34,1131,1157, 46,1157,1183, 34,1183,1206, 46,1206,1224, 34,1224,1242, 61,1242,1260, 46,1260,1278, 61,1278,1296, 46,1296,1314, 61,1314,1332, 46,1332,1350, 61,1350,1368, 46,1368,1381, 23,1381,1382, 46,1382,1383, 69,1383,1384, 92,1384,1385, 115,1385,1386, 137,1386,1387, 23,1387,1389, 46,1389,1390, 69,1390,1391, 92,1391,1392, 115,1392,1393, 137,1393,1394, 160,1394,1395, 17,1395,1396, 23,1396,1397, 29,1397,1398, 35,1398,1399, 40,1399,1400, 46,1400,1401, 52,1401,1402, 57,1402,1403, 63,1403,1404, 69,1404,1405, 75,1405,1406, 80,1406,1407, 86,1407,1408, 92,1408,1409, 126,1409,1411, 137,1411,1559, 15,1559,1570, 20,1570,1583, 15,1583,0};
const uint music_dataNoise[]={343,1381,1523, 343,1530,0};





//方波0//////////////////
uint i0=0;// 数组位置
uint Tone0 ;//半音长(相当于频率)
uint fcounter0;//音长计数
uchar volume0;//音量 
uchar swap0=0;//切换开关

//方波1//////////////////
uint i1=0;// 数组位置
uint Tone1 ;//半音长(相当于频率)
uint fcounter1;//音长计数
uchar volume1;//音量 
uchar swap1=0;//切换开关

//三角波//////////////////
uint i2=0; 
uint Tone2 ; 
uint fcounter2; 
uchar volume2=6*8;//三角波音量固定为6 
uchar swap2=0; 

//杂波//////////////////
uint i3=0; 
uint Tone3 ; 
uint fcounter3; 
uchar volume3=4*8;//杂波音量固定 
uchar swap3=0; 

uint sum_volume;//总音量 
uint T=0;//时间计数


void init_devices(void)
{
    
    DDRD=0b10000000;  
    PORTD=0b10000000; 
    
    //#####定时器2/PD7(OC2)pwm控制音量,周期为32us(31.2KHz)######
    TCCR2=0X01;//内部CK/1脉冲
    SET_BIT(TCCR2,WGM20);    //快速PWM方式
    SET_BIT(TCCR2,WGM21);
    SET_BIT(TCCR2,COM21); //减1匹配置位
    OCR2=255;
    //####################
    
    //#####定时器1,周期为0.025ms对音频采样######
    SET_BIT(TCCR1B,CS11);//8分频	
    SET_BIT(TCCR1B,WGM12);//CTC方式,匹配清零后自动计数
    OCR1A=25;
    TCNT1=0;
    SET_BIT(TIMSK,OCIE1A);
    //####################
    
    //#####定时器0,周期为1/60s(16.67ms),对时间进行计数######
    SET_BIT(TCCR0,CS00);//1024分频
    SET_BIT(TCCR0,CS02);
    SET_BIT(TCCR0,WGM01);//CTC方式,匹配清零后自动计数
    OCR0=133;//定时时间
    TCNT0=0;
    SET_BIT(TIMSK,OCIE0);
    //####################
    
    
    
    SET_BIT(SREG,7);  //全局中断
}


void main(void)  
{
    init_devices();
    while(1)
    {
    }
}

void delay_1ms(void)//微秒级延时,单位1微秒
{
    uint i;
    for(i=0;i<(unsigned int)(8*143-2);i++);
}


void delay_ms(uint num)//毫秒级精确延时,单位1毫秒(8M)
{
    uint i;
    for(i=0;i<num;i++) delay_1ms();
}


//#####定时器0,周期为1/60s(16.67ms),对时间T进行计数
#pragma  interrupt_handler T0_counter:20
void T0_counter(void)  
{
    T++;
    
    if(music_dataRect0[i0]==9999)//到尾部了，从头开始
    {
        delay_ms(1000);
        i0=0;i1=0;i2=0;i3=0;
		volume0=0;volume1=0;volume2=0;volume3=0;
        T=0;
    }
    
    //方波0//////////////////
	if(T>=music_dataRect0[i0-1])volume0=0;//是否结束了
    if(T>=music_dataRect0[i0+2])
    {
        Tone0=music_dataRect0[i0];
        volume0=music_dataRect0[i0+1]*8;
        fcounter0=0;
        i0+=4;
    }    
    
    //方波1//////////////////
	if(T>=music_dataRect1[i1-1])volume1=0;//是否|结束时间|了
    if(T>=music_dataRect1[i1+2])
    {
        Tone1=music_dataRect1[i1];
        volume1=music_dataRect1[i1+1]*8;
        fcounter1=0;
        i1+=4;
    }   
    
    //三角波//////////////////
	if(T>=music_dataTriangle[i2-1])volume2=0;//是否|结束时间|了
    if(T>=music_dataTriangle[i2+1])
    {
        Tone2=music_dataTriangle[i2];
		volume2=6*8;
        fcounter2=0;
        i2+=3;
    }  
    
    //杂波
	if(T>=music_dataNoise[i3-1])volume3=0;//是否|结束时间|了
    if(T>=music_dataNoise[i3+1])
    {
        Tone3=music_dataNoise[i3];
		volume3=6*8;
        fcounter3=0;
        i3+=3;
    }  	  
    
}


//#####定时器1,周期为0.025ms对音频采样
#pragma  interrupt_handler T1_counter:7
void T1_counter(void)  
{
    
    //方波0//////////////////
    fcounter0++;//音长计数
    if(fcounter0==Tone0)
    {
        swap0=(~swap0);
        fcounter0=0;
    }
    
    //方波1//////////////////
    fcounter1++;//音长计数
    if(fcounter1==Tone1)
    {
        swap1=(~swap1);
        fcounter1=0;
    }
    
    //三角波//////////////////
    fcounter2++;//音长计数
    if(fcounter2==Tone2)
    {
        swap2=(~swap2);
        fcounter2=0;
    }
    
    //杂波
    fcounter3++;//音长计数
    if(fcounter3==Tone3)
    {
        swap3=(~swap3);
        fcounter3=0;
    }
    
    sum_volume=0;
    if(swap0) sum_volume=volume0;//音量相加
    if(swap1) sum_volume+=volume1;//音量相加
    if(swap2) sum_volume+=volume2;//音量相加	
    if(swap3) sum_volume+=volume3;//音量相加		
    if(sum_volume>255)sum_volume=255;//限制最大音量
    
    OCR2=sum_volume;
}


