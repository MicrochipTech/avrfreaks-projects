<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>AVR SD Interface: sci.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>sci.c</h1><a href="a00008.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*************************************************************/</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;avr/io.h&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;avr/interrupt.h&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;inttypes.h&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include "<a class="code" href="a00009.html" title="SCI/UART interface.">sci.h</a>"</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include "<a class="code" href="a00007.html" title="Circular queue header.">queue.h</a>"</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="preprocessor">#ifndef __B_RATE</span>
<a name="l00023"></a>00023 <span class="preprocessor"></span><span class="preprocessor">  #define __B_RATE 9600</span>
<a name="l00024"></a>00024 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00025"></a>00025 <span class="preprocessor"></span>
<a name="l00026"></a>00026 <span class="keywordtype">int</span> <a class="code" href="a00008.html#4ca7682243ef6d186031b3c8a600d396" title="Put a character into the UART queue.">SCI_PutChar</a>(<span class="keywordtype">char</span>, FILE *);
<a name="l00027"></a>00027 <span class="keywordtype">int</span> <a class="code" href="a00008.html#6f3f32be2d6f725e3ae5506e8688694a" title="Get a character from the UART queue.">SCI_GetChar</a>(FILE *);
<a name="l00028"></a>00028 
<a name="l00030"></a><a class="code" href="a00008.html#440289313544b250a7eb01c35724793d">00030</a> <span class="preprocessor">#define UBRRH_BAUD (F_CPU/16/__B_RATE-1)</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span>
<a name="l00033"></a><a class="code" href="a00008.html#609e83e69671ce88d53aa44a7a9d5f42">00033</a> <span class="keyword">static</span> <a class="code" href="a00002.html" title="Queue structure.">Queue</a> <a class="code" href="a00008.html#609e83e69671ce88d53aa44a7a9d5f42" title="Circular recieve buffer.">SCI_TxBuffer</a>;
<a name="l00035"></a><a class="code" href="a00008.html#0493e4cf9af402f4c84f11310b6679d8">00035</a> <span class="keyword">static</span> <a class="code" href="a00002.html" title="Queue structure.">Queue</a> <a class="code" href="a00008.html#0493e4cf9af402f4c84f11310b6679d8" title="Circular transmit buffer.">SCI_RxBuffer</a>;
<a name="l00036"></a>00036 
<a name="l00038"></a><a class="code" href="a00008.html#aa1fc0ff1aeb77f1feff261fa5ea792b">00038</a> <span class="keyword">static</span> FILE <a class="code" href="a00008.html#aa1fc0ff1aeb77f1feff261fa5ea792b" title="Special stdout to bind to serial port.">mystdout</a> = FDEV_SETUP_STREAM(<a class="code" href="a00008.html#4ca7682243ef6d186031b3c8a600d396" title="Put a character into the UART queue.">SCI_PutChar</a>, NULL, _FDEV_SETUP_WRITE);
<a name="l00040"></a><a class="code" href="a00008.html#3d3822358b228d94f0927a1cc7af7433">00040</a> <span class="keyword">static</span> FILE <a class="code" href="a00008.html#3d3822358b228d94f0927a1cc7af7433" title="Special stdin to bind to serial port.">mystdin</a>  = FDEV_SETUP_STREAM(NULL, <a class="code" href="a00008.html#6f3f32be2d6f725e3ae5506e8688694a" title="Get a character from the UART queue.">SCI_GetChar</a>, _FDEV_SETUP_READ);
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 
<a name="l00048"></a>00048 <span class="keywordtype">int</span>
<a name="l00049"></a><a class="code" href="a00008.html#4ca7682243ef6d186031b3c8a600d396">00049</a> <a class="code" href="a00008.html#4ca7682243ef6d186031b3c8a600d396" title="Put a character into the UART queue.">SCI_PutChar</a>(<span class="keywordtype">char</span> input, FILE * stream) {
<a name="l00050"></a>00050   uint8_t err = 0;
<a name="l00051"></a>00051   <span class="keywordflow">if</span>(input == <span class="charliteral">'\n'</span>)
<a name="l00052"></a>00052     <a class="code" href="a00008.html#4ca7682243ef6d186031b3c8a600d396" title="Put a character into the UART queue.">SCI_PutChar</a>(<span class="charliteral">'\r'</span>, stream);
<a name="l00053"></a>00053 
<a name="l00054"></a>00054   <span class="keywordflow">do</span>{
<a name="l00055"></a>00055     cli();
<a name="l00056"></a>00056     err = !<a class="code" href="a00006.html#c87add5950878e717170d7ce624534f5" title="Place data on to a Queue.">en_q</a>(input, &amp;SCI_TxBuffer);
<a name="l00057"></a>00057     sei();
<a name="l00058"></a>00058   }<span class="keywordflow">while</span>(err);
<a name="l00059"></a>00059   UCSRB |= _BV(UDRIE);
<a name="l00060"></a>00060   <span class="keywordflow">return</span> 0;
<a name="l00061"></a>00061 }
<a name="l00062"></a>00062 
<a name="l00068"></a>00068 <span class="keywordtype">int</span>
<a name="l00069"></a><a class="code" href="a00008.html#6f3f32be2d6f725e3ae5506e8688694a">00069</a> <a class="code" href="a00008.html#6f3f32be2d6f725e3ae5506e8688694a" title="Get a character from the UART queue.">SCI_GetChar</a>(FILE * stream) {
<a name="l00070"></a>00070   <span class="keywordtype">char</span> ret_val;
<a name="l00071"></a>00071   uint8_t err = 0;
<a name="l00072"></a>00072   <span class="keywordflow">do</span>{
<a name="l00073"></a>00073     cli();
<a name="l00074"></a>00074     err = !<a class="code" href="a00006.html#fc61c51b78122d1a067b7545c4e29016" title="Grab data from a Queue.">de_q</a>((uint8_t *)&amp;ret_val, &amp;SCI_RxBuffer);
<a name="l00075"></a>00075     sei();
<a name="l00076"></a>00076   }<span class="keywordflow">while</span>(err); <span class="comment">// Poll till something is in buffer</span>
<a name="l00077"></a>00077   <span class="keywordflow">return</span> ret_val;
<a name="l00078"></a>00078 }
<a name="l00079"></a>00079 
<a name="l00086"></a>00086 <span class="keywordtype">void</span>
<a name="l00087"></a><a class="code" href="a00009.html#ed92abc4d8f56a11cdbd5e7fc4711b8f">00087</a> <a class="code" href="a00008.html#ed92abc4d8f56a11cdbd5e7fc4711b8f" title="Initialize the SCI.">SCI_Init</a>(<span class="keywordtype">void</span>) {
<a name="l00088"></a>00088   <span class="comment">/* Set Baud Rate. */</span>
<a name="l00089"></a>00089   UBRRH = (uint8_t)(<a class="code" href="a00008.html#440289313544b250a7eb01c35724793d" title="Calculation for prescaler. Define F_CPU in Makefile.">UBRRH_BAUD</a>&gt;&gt;8);
<a name="l00090"></a>00090   UBRRL = (uint8_t)(<a class="code" href="a00008.html#440289313544b250a7eb01c35724793d" title="Calculation for prescaler. Define F_CPU in Makefile.">UBRRH_BAUD</a>);
<a name="l00091"></a>00091 
<a name="l00092"></a>00092   <span class="comment">/* Enable Rx and Tx, and interrupt */</span>
<a name="l00093"></a>00093   UCSRB = _BV(RXCIE) | _BV(RXEN) | _BV(TXEN);
<a name="l00094"></a>00094 
<a name="l00095"></a>00095   <span class="comment">/* Frame Format - 8 data, no parity */</span>
<a name="l00096"></a>00096   <span class="comment">/* NEED URSEL FOR MEGA16/32 */</span>
<a name="l00097"></a>00097   UCSRC = _BV(URSEL) | _BV(UCSZ1) | _BV(UCSZ0);<span class="comment">// | _BV(UPM1) | _BV(UPM0);</span>
<a name="l00098"></a>00098 
<a name="l00099"></a>00099   stdout = &amp;<a class="code" href="a00008.html#aa1fc0ff1aeb77f1feff261fa5ea792b" title="Special stdout to bind to serial port.">mystdout</a>;
<a name="l00100"></a>00100   stdin = &amp;<a class="code" href="a00008.html#3d3822358b228d94f0927a1cc7af7433" title="Special stdin to bind to serial port.">mystdin</a>;
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00108"></a><a class="code" href="a00008.html#ba0bbb0ed7835d8e8b8512d276409746">00108</a> <a class="code" href="a00008.html#ba0bbb0ed7835d8e8b8512d276409746" title="Handle recieved data.">ISR</a>(SIG_USART_RECV) {
<a name="l00109"></a>00109   uint8_t rx_data = UDR;
<a name="l00110"></a>00110   <a class="code" href="a00006.html#c87add5950878e717170d7ce624534f5" title="Place data on to a Queue.">en_q</a>(rx_data, &amp;SCI_RxBuffer); <span class="comment">// Fail silently</span>
<a name="l00111"></a>00111   <span class="comment">//en_q(rx_data, &amp;SCI_TxBuffer); UCSRB |= _BV(UDRIE); // echo?</span>
<a name="l00112"></a>00112 }
<a name="l00113"></a>00113 
<a name="l00117"></a><a class="code" href="a00008.html#d8a81bfa00989e4a9c86400f02e8346b">00117</a> <a class="code" href="a00008.html#ba0bbb0ed7835d8e8b8512d276409746" title="Handle recieved data.">ISR</a>(SIG_USART_DATA) {
<a name="l00118"></a>00118   uint8_t tx_data;
<a name="l00119"></a>00119   uint8_t err = 0;
<a name="l00120"></a>00120   err = !<a class="code" href="a00006.html#fc61c51b78122d1a067b7545c4e29016" title="Grab data from a Queue.">de_q</a>(&amp;tx_data, &amp;SCI_TxBuffer);
<a name="l00121"></a>00121   <span class="keywordflow">if</span>(err)
<a name="l00122"></a>00122     UCSRB &amp;= ~_BV(UDRIE);
<a name="l00123"></a>00123   <span class="keywordflow">else</span>
<a name="l00124"></a>00124     UDR = tx_data;
<a name="l00125"></a>00125 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Sun Mar 8 19:13:34 2009 for AVR SD Interface by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
