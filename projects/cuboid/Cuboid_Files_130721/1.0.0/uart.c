/*
	Uart module
*/

#include "includes.h"

//********************************************************************************************************
// Configurable defines
//********************************************************************************************************

	#define UART1_BAUD		38400

//********************************************************************************************************
// Local defines
//********************************************************************************************************

//********************************************************************************************************
// Public variables
//********************************************************************************************************

	void (*uart1_rx_ptr)(char x) = NULL;
	
//********************************************************************************************************
// Private variables
//********************************************************************************************************

//********************************************************************************************************
// Private prototypes
//********************************************************************************************************

//********************************************************************************************************
// Public functions
//********************************************************************************************************

void uart1_init(void)
{
	// Setup Uart1
	DDRD |=_BV(PD3);			// UTX1 output
	DDRD &=~_BV(PD2);			// URX1 input
	UCSR1B |= _BV(TXEN1);		// enable tx
	UCSR1B |= _BV(RXEN1);		// enable rx
	UCSR1B |= _BV(RXCIE1);		// enable rx interrupt
 
	#define BAUD UART1_BAUD
	#include <util/setbaud.h>
	UBRR1H = UBRRH_VALUE;
	UBRR1L = UBRRL_VALUE;
	#if USE_2X
		UCSRA |= _BV(U2X1);
	#else
		UCSR1A &= _BV(U2X1);
	#endif
	#undef BAUD
}

void uart1_tx_char(char x)
{
	while(!(UCSR1A & _BV(UDRE1)));
	UDR1 = x;
}

void uart1_tx_string(char* text)
{
	while(*text)
	{
		while(!(UCSR1A & _BV(UDRE1)));
		UDR1 = *text++;
	};
}
	
void uart1_tx_string_P(PGM_P text)
{
	while(pgm_read_byte(text))
	{
		while(!(UCSR1A & _BV(UDRE1)));
		UDR1 = pgm_read_byte(text++);
	};
}

ISR(USART1_RX_vect)
{
	static volatile char rx_char;
	rx_char = UDR1;
	
	//call function ptr only if !NULL
	if(uart1_rx_ptr)
		(*uart1_rx_ptr)(rx_char);
}

//********************************************************************************************************
// Private functions
//********************************************************************************************************
