/* Test tool for IR remote receiver/transmitter */

#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <fcntl.h>
#include <errno.h>
#include <termios.h>
#include <asm/ioctls.h>

#define PULSE_MASK 0x00FFFFFF
#define PULSE_BIT  0x01000000
 
static int fd;
static char fname[256];
static unsigned char HexTab[] = {
      0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
      0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
      0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
      0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
      0xFF,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
      0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
      0xFF,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
      0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
      0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
      0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
      0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
      0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
      0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
      0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
      0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
      0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
   };


int init(void) {

	fd = open ("/dev/ttyACM0", O_RDWR|O_NOCTTY|O_NDELAY);
	if (fd==-1) {
	   perror("unable to open /dev/ttyACM0");
	   return (-3);
	} else {
	   fcntl(fd,F_SETFL,FNDELAY);  // non-blocking read
//	   fcntl(fd, F_SETFL, 0);      // blocking read

	   printf("device /dev/ttyACM0 opened\n");
	}

	struct termios options;

	/* get the current options */
	tcgetattr(fd, &options);

	/* set raw input */
	options.c_cflag     |= (CLOCAL | CREAD);
	options.c_lflag     &= ~(ICANON | ECHO | ECHOE | ISIG);
	options.c_oflag     &= ~OPOST;

	/* set the options */
	tcsetattr(fd, TCSANOW, &options);

	int n = write(fd,"\r\n",2);
	if (n<0) {
	   perror("send test failed");
           return (-4);
	} else {
	   printf("send test succeeded\n");
	}

	return (1);
}


void Transmit(void) {
	int rtn, dfd, k, l, n, t;
	char c, base[6];

	printf("\nTRANSMIT\n\n");

	dfd = open(fname, O_RDONLY);
	if (dfd == -1) {
	   printf("unable to open %s file", fname);
	   return;
	} else {
	   printf("txdata file opened\n\n");
	}	

	while ((rtn = read (dfd,&c,1))!=0) {
	   if (rtn<0) {
	      perror("read txdata error");
	      return;
	   }

	   /* data are expected to be in native format so we just copy
	      characters 0-9, A-F, a-f, +, -, # aned $ to IRmega */
 
	   if ( (HexTab[c&0x7F]<16) ||    // hex char or flag
	      (c=='+') || (c=='-') || (c=='#') || (c=='$')) {
	      printf("%c",c);
	      t=20;
	      n = write (fd, &c, 1);
	      while ((n!=1) && (t-->0)) {
		 usleep(5000);
		 n = write (fd, &c, 1);
	      }
	      if (t=0) {
		 perror("send error");
		 close(dfd);
		 return;
	      }
	   }
	}  // end of while loop

	close(dfd);
}


int main (int argc, char *argv[]) {

	if (argc!=2) {
		printf("\nUsage: test data_file_name, argc=%d\n", argc);
		return (-1);
	}

	strcpy(fname, argv[1]);
	if (init()<0) return -1;

	while (1) {
		Transmit();
		printf("\nnext\n");
		sleep(1);
	}

	printf("Closing /dev/ttyACM0\n");
	close(fd);
	return 0;
}

